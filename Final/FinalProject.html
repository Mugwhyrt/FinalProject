<!DOCTYPE html>
<html>
	<head>
		<meta charset = "utf-8">
		<title> Final Project </title>
		<style>
			body { margin: 0; }
			canvas { width: 100%; heigh: 100% }
		</style>
	</head>
	<body>
		<script src = "../three.js-master/build/three.js"></script>
		<script src = "building.js"></script>
                <script src ="CameraControls.js"></script>
                <script src = "material.js"></script>
		<script>
                    /*
                        TO DO
                            + Migrate camera related stuff to CameraControls
                    */
                    // Turn off default arrow key functions
                    // to prevent window from scrolling
                    // when user applies camera rotation
                    window.addEventListener("keydown", function(e) {
                    // space and arrow keys
                    if([32, 37, 38, 39, 40].indexOf(e.keyCode) > -1) {
                     e.preventDefault();
                       }
                    }, false);
                    
                     // Initialize Camera Movement Vars
                    //
                    // boolean values for whether to apply a given
                    // transformation to the camera
                    var moveForward = false;
                    var moveBackward = false;
                    var moveLeft = false;
                    var moveRight = false;
                    var moveUp = false;
                    var moveDown = false;

                    var rotateLeft = false;
                    var rotateRight = false;
                    var rotateUp = false;
                    var rotateDown = false;

                    var moveRate = 0.085;
                    var turnRate = 0.035
                    
                     // Initialize Perspective Camera
                    // (FOV, Aspect Ratio, Near Clipping Plane, 
                    //  Far Clipping Plane)
                    var farView = 100;
                    var camera = 
                        new THREE.PerspectiveCamera(75, 
                                                    window.innerWidth / 
                                                    window.innerHeight,
                                                    0.1,
                                                    farView);
                    //var collisions = [];
                    function main(){
                    //
                    // Initialize Scene With Camera
                    //
                    var scene = new THREE.Scene();
                    scene.background = new THREE.Color(0xaaaaaa);
                    scene.fog = new THREE.Fog(0xaaaaaa);
                    scene.fog.far = farView / 2;
                   
                    //camera.position.z = 5;
                    camera.rotation.y = -Math.PI/2;
                    
                    // Set camera rotation order to Yaw/Pitch/Roll
                    camera.rotation.order = 'YXZ';
                    
                    var renderer = new THREE.WebGLRenderer();
                    renderer.setSize( window.innerWidth, window.innerHeight );
                    document.body.appendChild(renderer.domElement);
                    
                    document.addEventListener('keydown', onKeyDown, false);
                    document.addEventListener('keyup', onKeyUp, false);
                    
                    
                    // Add lights
                    const sunTarget = new THREE.Object3D;
                    sunTarget.position.z += 1;
                    sunTarget.position.x += 1;
                    sunTarget.position.y -= 1;
                    scene.add( sunTarget );
                    const directionalLight = new THREE.DirectionalLight( 0xffffff, 
                                                0.5 );
                    directionalLight.target = sunTarget;
                    scene.add( directionalLight );
                    
                    
                    var ambient = new THREE.AmbientLight(0x202020);
                    scene.add(ambient);
                    // Initialise Building Materials
                    var windowMaterial = new THREE.MeshPhongMaterial({color: 0x1044ff});
                    var walls = new THREE.MeshPhongMaterial({color: 0xffaa33});
                    var material = new THREE.MeshPhongMaterial( { color: 0x00ff00 } );

                    var loader = new THREE.TextureLoader();
                    wallMaterial = getMaterial();
                    
                    var groundMaterial = new THREE.MeshPhongMaterial({
                                            color : 0x11cc00, shininess : 10, side: THREE.DoubleSide});
                    
                    const streetMaterial = new THREE.MeshPhongMaterial({color:0x505050});
                                            
                    const city = new THREE.Object3D;
                    
                    var buildingBase = [10,10];
                    var blockDims = [30, buildingBase[1]+1, 5];
                    
                    
                    var block = getBlock(blockDims, buildingBase, streetMaterial, windowMaterial);
                    block.position.x -= blockDims[0] / 2 + buildingBase[1] + blockDims[2]/2;
                    block.position.z -= blockDims[1] / 2 + buildingBase[1] + blockDims[2]/2;
                    city.add(block);
      
                    block = getBlock(blockDims, buildingBase, streetMaterial, windowMaterial);
                    block.position.x += blockDims[0] / 2 + buildingBase[1] + blockDims[2]/2;
                    block.position.z -= blockDims[1] / 2 + buildingBase[1] + blockDims[2]/2;
                    city.add(block);
                    
                    block = getBlock(blockDims, buildingBase, streetMaterial, windowMaterial);
                    block.position.x -= blockDims[0] / 2 + buildingBase[1] + blockDims[2]/2;
                    block.position.z += blockDims[1] / 2 + buildingBase[1] + blockDims[2]/2;
                    city.add(block);
                    
                    block = getBlock(blockDims, buildingBase, streetMaterial, windowMaterial);
                    block.position.x += blockDims[0] / 2 + buildingBase[1] + blockDims[2]/2;
                    block.position.z += blockDims[1] / 2 + buildingBase[1] + blockDims[2]/2;
                    city.add(block);
                    
                    var groundGeo = new THREE.PlaneBufferGeometry(blockDims[0] * 10, 
                                        blockDims[1] * 10);
                    var ground = new THREE.Mesh(groundGeo, groundMaterial);
                    ground.position.z += blockDims[1] ;
                    ground.rotation.x = Math.PI/2;
                    ground.position.y -= 1;
                    city.add(ground);
                    
                    scene.add(city);
                    
                    function animate(){
                        requestAnimationFrame( animate );
                       
                        // Apply camera transformations based on
                        // keyboard input (including projection changes), 
                        // check collisions and boundary
                        // and undo transformations if neccessary
                        // All 3 functions found in CameraControls
                        applyCameraTransforms(camera);   
                        
                        renderer.render(scene, camera );
                    }
                    // animate on canvas
                    animate();
                    }
                    main();
		</script>
	</body>
</html>